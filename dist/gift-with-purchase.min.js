!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GiftWithPurchase={})}(this,function(t){"use strict";class e extends HTMLElement{#t=0;#e=0;#i=null;#s=!1;#a=!1;#r=!1;#d=null;#n=null;#h=null;#o=null;#u=null;#c=null;#l=null;#m=null;static get observedAttributes(){return["threshold","current","variant-id","promo-ended","message-above","message-below"]}constructor(){super(),this.#t=parseFloat(this.getAttribute("threshold"))||0,this.#e=parseFloat(this.getAttribute("current"))||0,this.#i=this.getAttribute("variant-id"),this.#r=this.hasAttribute("promo-ended"),this.#l=this.getAttribute("message-above"),this.#m=this.getAttribute("message-below"),this.#u=this.#p.bind(this)}connectedCallback(){this.#g(),this.#v(),this.#b()}disconnectedCallback(){this.#c&&clearTimeout(this.#c),this.#d&&this.#d.removeEventListener("cart-dialog:data-changed",this.#u)}attributeChangedCallback(t,e,i){e!==i&&("threshold"===t?this.#t=parseFloat(i)||0:"current"===t?this.#e=parseFloat(i)||0:"variant-id"===t?this.#i=i:"promo-ended"===t?this.#r=null!==i:"message-above"===t?this.#l=i:"message-below"===t&&(this.#m=i),this.#v())}#g(){this.#n=this.querySelector("[data-gwp-image]"),this.#h=this.querySelector("[data-gwp-title]"),this.#o=this.querySelector("[data-gwp-variant]"),this.classList.add("gift-with-purchase"),this.#A()}#A(){let t=this.querySelector(".gwp-message");t||!this.#l&&!this.#m||(t=document.createElement("div"),t.className="gwp-message",this.appendChild(t)),this.#w()}#w(){const t=this.querySelector(".gwp-message");if(!t)return;let e="";if(this.#s&&this.#l)e=this.#l;else if(!this.#s&&this.#m){const t=this.#t-this.#e;e=this.#m.replace("{{ amount }}",t.toFixed(2))}t.textContent=e,t.style.display=e?"block":"none"}#b(){this.#d=this.closest("cart-panel"),this.#d&&this.#d.addEventListener("cart-dialog:data-changed",this.#u)}#p(t){const e=t.detail;e&&void 0!==e.total_price&&(this.#c&&clearTimeout(this.#c),this.#c=setTimeout(()=>{this.#c=null,this.setCurrentAmount(e.total_price/100),this.#f(e)},300))}#f(t){if(!t.items||!this.#i)return this.#a=!1,void this.#v();const e=t.items.filter(t=>t.variant_id.toString()===this.#i.toString()&&"true"===t.properties?._gwp_item);this.#a=e.length>0,this.#r&&e.length&&this.#C(e),this.#v()}#v(){const t=this.#s;this.#s=this.#e>=this.#t&&!this.#r,this.#r?(this.setAttribute("data-promo-ended","true"),this.removeAttribute("data-active"),this.removeAttribute("data-inactive")):this.#s?(this.setAttribute("data-active","true"),this.removeAttribute("data-inactive"),this.removeAttribute("data-promo-ended")):(this.setAttribute("data-inactive","true"),this.removeAttribute("data-active"),this.removeAttribute("data-promo-ended")),this.toggleAttribute("data-added",this.#a),this.#r||(this.#s&&!t&&!this.#a&&this.#i?this.#E():!this.#s&&t&&this.#a&&this.#i&&this.#y()),this.#I(),this.#w()}#I(){if(this.classList.remove("gwp-inactive","gwp-active","gwp-added","gwp-ended"),this.#r)return this.classList.add("gwp-ended"),void(this.style.display="none");this.style.display="",this.classList.add(this.#a?"gwp-added":this.#s?"gwp-active":"gwp-inactive")}#S(t){t&&this.dispatchEvent(new CustomEvent("cart-dialog:data-changed",{detail:t,bubbles:!0}))}async#E(){try{const t=await fetch("/cart/add.js",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({items:[{id:this.#i,quantity:1,properties:{_gwp_item:"true",_hide_in_cart:"true"}}]})});if(!t.ok)throw new Error(`http ${t.status}`);const e=await t.json();this.#a=!0,this.#v(),this.#S(e),this.dispatchEvent(new CustomEvent("gwp:added",{detail:{variantId:this.#i},bubbles:!0}))}catch(t){console.error("giftwithpurchase: add error",t),this.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"add",error:t.message},bubbles:!0}))}}async#y(){try{const t=(await(await fetch("/cart.js",{credentials:"same-origin"})).json()).items.filter(t=>t.variant_id.toString()===this.#i.toString()&&"true"===t.properties?._gwp_item);if(!t.length)return this.#a=!1,void this.#v();await this.#C(t)}catch(t){console.error("giftwithpurchase: remove error",t),this.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"remove",error:t.message},bubbles:!0}))}}async#C(t){try{await Promise.all(t.map(t=>fetch("/cart/change.js",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({id:t.key,quantity:0})}))),this.#a=!1,this.#v(),this.dispatchEvent(new CustomEvent("gwp:removed",{detail:{variantId:this.#i},bubbles:!0}))}catch(t){console.error("giftwithpurchase: bulk remove error",t),this.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"remove",error:t.message},bubbles:!0}))}}setCurrentAmount(t){this.#e=parseFloat(t)||0,this.setAttribute("current",this.#e.toString()),this.#v()}setThreshold(t){this.#t=parseFloat(t)||0,this.setAttribute("threshold",this.#t.toString()),this.#v()}setVariantId(t){this.#i=t,this.setAttribute("variant-id",t)}setPromoEnded(t){this.#r=!!t,t?this.setAttribute("promo-ended",""):this.removeAttribute("promo-ended"),this.#v()}getState(){return{currentAmount:this.#e,threshold:this.#t,variantId:this.#i,isActive:this.#s,isAdded:this.#a,promoEnded:this.#r,remainingAmount:Math.max(0,this.#t-this.#e)}}updateProduct({image:t,title:e,variantTitle:i,alt:s}={}){t&&this.#n&&(this.#n.src=t,s&&(this.#n.alt=s)),e&&this.#h&&(this.#h.textContent=e),i&&this.#o&&(this.#o.textContent=i)}get currentAmount(){return this.#e}get threshold(){return this.#t}get variantId(){return this.#i}get isActive(){return this.#s}get isAdded(){return this.#a}get promoEnded(){return this.#r}}customElements.get("gift-with-purchase")||customElements.define("gift-with-purchase",e),t.GiftWithPurchase=e});
//# sourceMappingURL=gift-with-purchase.min.js.map
