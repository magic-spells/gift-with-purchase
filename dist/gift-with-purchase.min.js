!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).GiftWithPurchase={})}(this,function(e){"use strict";class t extends HTMLElement{#e=0;#t=0;#a=null;#r=!1;#s=!1;#i=!1;#n=!0;#o=!1;#d=null;#l={};#c=null;#u=null;#h=!1;#m=null;#p=null;#g=null;#b=null;static get observedAttributes(){return["threshold","current","variant-id","promo-ended","product-available","message-above","message-below","money-format"]}constructor(){super();const e=this;e.#e=parseFloat(e.getAttribute("threshold"))||0,e.#t=parseFloat(e.getAttribute("current"))||0,e.#a=e.getAttribute("variant-id"),e.#i=e.hasAttribute("promo-ended"),e.#n=e.#v(e.getAttribute("product-available"),!0),e.#p=e.getAttribute("message-above"),e.#g=e.getAttribute("message-below"),e.#b=e.getAttribute("money-format"),e.#l={cartDataChange:e.#A.bind(e)}}connectedCallback(){const e=this;e.#f(),e.#y(),e.#C(),e.#w()}#f(){const e=this,t=e.#T();e.#o=e.#i||!e.#n,e.#r=e.#t>=t&&!e.#o}disconnectedCallback(){const e=this;e.#c&&clearTimeout(e.#c),e.#u&&clearTimeout(e.#u),e.#d&&e.#d.removeEventListener("cart-panel:data-changed",e.#l.cartDataChange)}attributeChangedCallback(e,t,a){const r=this;if(t!==a){switch(e){case"threshold":r.#e=parseFloat(a)||0;break;case"current":r.#t=parseFloat(a)||0;break;case"variant-id":r.#a=a;break;case"promo-ended":r.#i=null!==a;break;case"product-available":r.#n=r.#v(a,!0);break;case"message-above":r.#p=a;break;case"message-below":r.#g=a;break;case"money-format":r.#b=a}r.isConnected&&(r.#f(),r.#C(),r.#I())}}#y(){this.classList.add("gift-with-purchase"),this.#E()}#E(){this.#I()}#S(e){if(!this.#b)return e.toFixed(2).replace(/\.00$/,"");const t=e.toFixed(2),a=Math.round(e).toString(),r=t.replace(".",","),s=a.replace(/\B(?=(\d{3})+(?!\d))/g,",");return this.#b.replace(/\{\{\s*amount_no_decimals_with_comma_separator\s*\}\}/g,s).replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g,r).replace(/\{\{\s*amount_no_decimals\s*\}\}/g,a).replace(/\{\{\s*amount\s*\}\}/g,t)}#T(){const e=parseFloat(window.Shopify?.currency?.rate)||1;return this.#e*e}#v(e,t=!0){if(null==e)return t;if(""===e)return!0;const a=String(e).trim().toLowerCase();return"false"!==a&&"0"!==a&&("true"===a||"1"===a||t)}#I(){const e=this,t=e.querySelector("[data-content-gwp-message]");if(!t)return;let a="";if(e.#r&&e.#p)a=e.#p;else if(!e.#r&&e.#g){const t=e.#T()-e.#t,r=e.#S(t);a=e.#g.replace(/\[\s*amount\s*\]/g,r).replace(/\[amount\]/g,r)}t.textContent=a,t.style.display=a?"block":"none"}#w(){const e=this;e.#d=e.closest("cart-panel"),e.#d?e.#d.addEventListener("cart-panel:data-changed",e.#l.cartDataChange):e.#u=setTimeout(()=>{e.#u=null,e.#d=e.closest("cart-panel"),e.#d?e.#d.addEventListener("cart-panel:data-changed",e.#l.cartDataChange):console.error("GWP - cart-panel still not found after delay")},100)}#A(e){const t=this,a=e.detail;a&&void 0!==a.calculated_subtotal&&(t.#c&&clearTimeout(t.#c),t.#c=setTimeout(()=>{t.#c=null,t.#t=parseFloat(a.calculated_subtotal/100)||0,t.#_(a),t.#M(a)},300))}#_(e){const t=this.#k(e,!0);this.#s=t.length>0}#k(e,t=!0){const a=this;return e?.items?e.items.filter(e=>"true"===e.properties?._gwp_item&&(!t||!!a.#a&&e.variant_id?.toString()===a.#a.toString())):[]}#P(){const e=this;if(e.#m){const t=e.#m;e.#m=null,e.#_(t),e.#M(t)}}#M(e){const t=this;if(t.#h)return void(t.#m=e);const a=t.#r,r=t.#T();t.#o=t.#i||!t.#n,t.#r=t.#t>=r&&!t.#o,t.#o?t.#F(e):t.#r&&!a&&!t.#s&&t.#a?t.#G():!t.#r&&t.#s&&t.#a&&t.#D(e),t.#C(),t.#I()}#C(){const e=this;return e.#i?(e.setAttribute("state","ended"),void(e.style.display="none")):e.#n?(e.style.display="",void(e.#s?e.setAttribute("state","added"):e.#r?e.setAttribute("state","active"):e.setAttribute("state","inactive"))):(e.setAttribute("state","disabled"),void(e.style.display="none"))}async#G(){const e=this;e.#h=!0;try{const t=await fetch("/cart/add.js",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({items:[{id:e.#a,quantity:1,properties:{_gwp_item:"true",_hide_in_cart:"true",_ignore_price_in_subtotal:"true"}}]})});if(!t.ok)throw new Error(`http ${t.status}`);await t.json(),e.#s=!0,e.dispatchEvent(new CustomEvent("gwp:added",{detail:{variantId:e.#a},bubbles:!0})),e.#d?.getCartAndRefresh()}catch(t){console.error("giftwithpurchase: add error",t),e.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"add",error:t.message},bubbles:!0}))}finally{e.#h=!1,e.#P()}}async#D(e){const t=this;if(!e?.items)return;const a=t.#k(e,!0);if(a.length){t.#h=!0;try{await t.#L(a)}finally{t.#h=!1,t.#P()}}else t.#s=!1}async#F(e){const t=this;if(!e?.items)return;const a=t.#k(e,!1);if(a.length){t.#h=!0;try{await t.#L(a)}finally{t.#h=!1,t.#P()}}else t.#s=!1}async#L(e){const t=this;try{await Promise.all(e.map(async e=>{const t=await fetch("/cart/change.js",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({id:e.key,quantity:0})});if(!t.ok)throw new Error(`http ${t.status}`)})),t.#s=!1,t.dispatchEvent(new CustomEvent("gwp:removed",{detail:{variantId:t.#a},bubbles:!0})),t.#d?.getCartAndRefresh()}catch(e){console.error("giftwithpurchase: bulk remove error",e),t.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"remove",error:e.message},bubbles:!0}))}}getState(){const e=this,t=e.#T();return{currentAmount:e.#t,threshold:e.#e,convertedThreshold:t,variantId:e.#a,isActive:e.#r,isAdded:e.#s,promoEnded:e.#i,productAvailable:e.#n,isDisabled:e.#o,remainingAmount:Math.max(0,t-e.#t),currencyRate:parseFloat(window.Shopify?.currency?.rate)||1}}get currentAmount(){return this.#t}get threshold(){return this.#e}get variantId(){return this.#a}get isActive(){return this.#r}get isAdded(){return this.#s}get promoEnded(){return this.#i}get productAvailable(){return this.#n}get isDisabled(){return this.#o}setCurrentAmount(e){const t=this;t.#t=parseFloat(e)||0,t.#M({items:[]}),t.#I()}setThreshold(e){const t=this;t.#e=parseFloat(e)||0,t.#M({items:[]}),t.#I()}setVariantId(e){this.#a=e}}customElements.get("gift-with-purchase")||customElements.define("gift-with-purchase",t),e.GiftWithPurchase=t});
//# sourceMappingURL=gift-with-purchase.min.js.map
