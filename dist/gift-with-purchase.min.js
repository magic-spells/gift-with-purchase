!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).GiftWithPurchase={})}(this,function(e){"use strict";class t extends HTMLElement{#e=0;#t=0;#a=null;#r=!1;#s=!1;#n=!1;#i=null;#o={};#d=null;#c=null;#l=!1;#u=null;#h=null;#m=null;#g=null;static get observedAttributes(){return["threshold","current","variant-id","promo-ended","message-above","message-below","money-format"]}constructor(){super();const e=this;e.#e=parseFloat(e.getAttribute("threshold"))||0,e.#t=parseFloat(e.getAttribute("current"))||0,e.#a=e.getAttribute("variant-id"),e.#n=e.hasAttribute("promo-ended"),e.#h=e.getAttribute("message-above"),e.#m=e.getAttribute("message-below"),e.#g=e.getAttribute("money-format"),e.#o={cartDataChange:e.#p.bind(e)}}connectedCallback(){const e=this;e.#v(),e.#b(),e.#f(),e.#A()}#v(){const e=this,t=e.#y();e.#r=e.#t>=t&&!e.#n}disconnectedCallback(){const e=this;e.#d&&clearTimeout(e.#d),e.#c&&clearTimeout(e.#c),e.#i&&e.#i.removeEventListener("cart-panel:data-changed",e.#o.cartDataChange)}attributeChangedCallback(e,t,a){const r=this;if(t!==a){switch(e){case"threshold":r.#e=parseFloat(a)||0;break;case"current":r.#t=parseFloat(a)||0;break;case"variant-id":r.#a=a;break;case"promo-ended":r.#n=null!==a;break;case"message-above":r.#h=a;break;case"message-below":r.#m=a;break;case"money-format":r.#g=a}r.isConnected&&(r.#v(),r.#f(),r.#w())}}#b(){this.classList.add("gift-with-purchase"),this.#C()}#C(){this.#w()}#T(e){if(!this.#g)return e.toFixed(2).replace(/\.00$/,"");const t=e.toFixed(2),a=Math.round(e).toString(),r=t.replace(".",","),s=a.replace(/\B(?=(\d{3})+(?!\d))/g,",");return this.#g.replace(/\{\{\s*amount_no_decimals_with_comma_separator\s*\}\}/g,s).replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g,r).replace(/\{\{\s*amount_no_decimals\s*\}\}/g,a).replace(/\{\{\s*amount\s*\}\}/g,t)}#y(){const e=parseFloat(window.Shopify?.currency?.rate)||1;return this.#e*e}#w(){const e=this,t=e.querySelector("[data-content-gwp-message]");if(!t)return;let a="";if(e.#r&&e.#h)a=e.#h;else if(!e.#r&&e.#m){const t=e.#y()-e.#t,r=e.#T(t);a=e.#m.replace(/\[\s*amount\s*\]/g,r).replace(/\[amount\]/g,r)}t.textContent=a,t.style.display=a?"block":"none"}#A(){const e=this;e.#i=e.closest("cart-panel"),e.#i?e.#i.addEventListener("cart-panel:data-changed",e.#o.cartDataChange):e.#c=setTimeout(()=>{e.#c=null,e.#i=e.closest("cart-panel"),e.#i?e.#i.addEventListener("cart-panel:data-changed",e.#o.cartDataChange):console.error("GWP - cart-panel still not found after delay")},100)}#p(e){const t=this,a=e.detail;a&&void 0!==a.calculated_subtotal&&(t.#d&&clearTimeout(t.#d),t.#d=setTimeout(()=>{t.#d=null,t.#t=parseFloat(a.calculated_subtotal/100)||0,t.#I(a),t.#E(a)},300))}#I(e){const t=this;if(!e.items||!t.#a)return void(t.#s=!1);const a=e.items.filter(e=>e.variant_id.toString()===t.#a.toString()&&"true"===e.properties?._gwp_item);t.#s=a.length>0}#_(){const e=this;if(e.#u){const t=e.#u;e.#u=null,e.#I(t),e.#E(t)}}#E(e){const t=this;if(t.#l)return void(t.#u=e);const a=t.#r,r=t.#y();t.#r=t.#t>=r&&!t.#n,t.#n?t.#S(e):t.#r&&!a&&!t.#s&&t.#a?t.#M():!t.#r&&t.#s&&t.#a&&t.#S(e),t.#f(),t.#w()}#f(){const e=this;if(e.#n)return e.setAttribute("state","ended"),void(e.style.display="none");e.style.display="",e.#s?e.setAttribute("state","added"):e.#r?e.setAttribute("state","active"):e.setAttribute("state","inactive")}async#M(){const e=this;e.#l=!0;try{const t=await fetch("/cart/add.js",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({items:[{id:e.#a,quantity:1,properties:{_gwp_item:"true",_hide_in_cart:"true",_ignore_price_in_subtotal:"true"}}]})});if(!t.ok)throw new Error(`http ${t.status}`);await t.json(),e.#s=!0,e.dispatchEvent(new CustomEvent("gwp:added",{detail:{variantId:e.#a},bubbles:!0})),e.#i?.getCartAndRefresh()}catch(t){console.error("giftwithpurchase: add error",t),e.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"add",error:t.message},bubbles:!0}))}finally{e.#l=!1,e.#_()}}async#S(e){const t=this;if(!e?.items)return;const a=e.items.filter(e=>e.variant_id.toString()===t.#a.toString()&&"true"===e.properties?._gwp_item);if(a.length){t.#l=!0;try{await t.#k(a)}catch(e){console.error("giftwithpurchase: remove error",e),t.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"remove",error:e.message},bubbles:!0}))}finally{t.#l=!1,t.#_()}}else t.#s=!1}async#k(e){const t=this;try{await Promise.all(e.map(async e=>{const t=await fetch("/cart/change.js",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({id:e.key,quantity:0})});if(!t.ok)throw new Error(`http ${t.status}`)})),t.#s=!1,t.dispatchEvent(new CustomEvent("gwp:removed",{detail:{variantId:t.#a},bubbles:!0})),t.#i?.getCartAndRefresh()}catch(e){console.error("giftwithpurchase: bulk remove error",e),t.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"remove",error:e.message},bubbles:!0}))}}getState(){const e=this,t=e.#y();return{currentAmount:e.#t,threshold:e.#e,convertedThreshold:t,variantId:e.#a,isActive:e.#r,isAdded:e.#s,promoEnded:e.#n,remainingAmount:Math.max(0,t-e.#t),currencyRate:parseFloat(window.Shopify?.currency?.rate)||1}}get currentAmount(){return this.#t}get threshold(){return this.#e}get variantId(){return this.#a}get isActive(){return this.#r}get isAdded(){return this.#s}get promoEnded(){return this.#n}setCurrentAmount(e){const t=this;t.#t=parseFloat(e)||0,t.#E({items:[]}),t.#w()}setThreshold(e){const t=this;t.#e=parseFloat(e)||0,t.#E({items:[]}),t.#w()}setVariantId(e){this.#a=e}}customElements.get("gift-with-purchase")||customElements.define("gift-with-purchase",t),e.GiftWithPurchase=t});
//# sourceMappingURL=gift-with-purchase.min.js.map
