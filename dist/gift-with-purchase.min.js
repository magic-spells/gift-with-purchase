!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GiftWithPurchase={})}(this,function(t){"use strict";class e extends HTMLElement{#t=0;#e=0;#i=null;#s=!1;#a=!1;#r=!1;#n=null;#d=null;#o=null;#h=null;#l=null;static get observedAttributes(){return["threshold","current","variant-id","promo-ended","message-above","message-below"]}constructor(){super(),this.#t=parseFloat(this.getAttribute("threshold"))||0,this.#e=parseFloat(this.getAttribute("current"))||0,this.#i=this.getAttribute("variant-id"),this.#r=this.hasAttribute("promo-ended"),this.#h=this.getAttribute("message-above"),this.#l=this.getAttribute("message-below"),this.#d=this.#c.bind(this)}connectedCallback(){this.#u(),this.#m()}disconnectedCallback(){this.#o&&clearTimeout(this.#o),this.#n&&this.#n.removeEventListener("cart-dialog:data-changed",this.#d)}#u(){this.classList.add("gift-with-purchase"),this.#g()}#g(){this.#p()}#p(){const t=this.querySelector("[data-content-gwp-message]");if(!t)return;let e="";if(this.#s&&this.#h)e=this.#h;else if(!this.#s&&this.#l){const t=(this.#t-this.#e).toFixed(2).replace(/\.00$/,"");e=this.#l.replace(/\{\s*amount\s*\}/g,t).replace(/\{amount\}/g,t)}t.textContent=e,t.style.display=e?"block":"none"}#m(){this.#n=this.closest("cart-dialog"),this.#n?this.#n.addEventListener("cart-dialog:data-changed",this.#d):setTimeout(()=>{this.#n=this.closest("cart-dialog"),this.#n?this.#n.addEventListener("cart-dialog:data-changed",this.#d):console.error("GWP - cart-dialog still not found after delay")},100)}#c(t){const e=t.detail;e&&void 0!==e.calculated_subtotal&&(this.#o&&clearTimeout(this.#o),this.#o=setTimeout(()=>{this.#o=null,this.#e=parseFloat(e.calculated_subtotal/100)||0,this.#v(e),this.#b(e)},300))}#v(t){if(!t.items||!this.#i)return void(this.#a=!1);const e=t.items.filter(t=>t.variant_id.toString()===this.#i.toString()&&"true"===t.properties?._gwp_item);this.#a=e.length>0,this.#r&&e.length&&this.#A(e)}#b(t){const e=this.#s;this.#s=this.#e>=this.#t&&!this.#r,this.#r&&this.#f(t),this.#s&&!e&&!this.#a&&this.#i?this.#w():!this.#s&&e&&this.#a&&this.#i&&this.#f(t),this.#C(),this.#p()}#C(){if(this.#r)return this.setAttribute("state","ended"),void(this.style.display="none");this.style.display="",this.#a?this.setAttribute("state","added"):this.#s&&this.setAttribute("state","active")}async#w(){try{const t=await fetch("/cart/add.js",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({items:[{id:this.#i,quantity:1,properties:{_gwp_item:"true",_hide_in_cart:"true",_ignore_price_in_subtotal:"true"}}]})});if(!t.ok)throw new Error(`http ${t.status}`);await t.json(),this.#a=!0,this.dispatchEvent(new CustomEvent("gwp:added",{detail:{variantId:this.#i},bubbles:!0}))}catch(t){console.error("giftwithpurchase: add error",t),this.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"add",error:t.message},bubbles:!0}))}}async#f(t){try{const e=t.items.filter(t=>t.variant_id.toString()===this.#i.toString()&&"true"===t.properties?._gwp_item);if(!e.length)return void(this.#a=!1);await this.#A(e)}catch(t){console.error("giftwithpurchase: remove error",t),this.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"remove",error:t.message},bubbles:!0}))}}async#A(t){try{await Promise.all(t.map(t=>fetch("/cart/change.js",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({id:t.key,quantity:0})}))),this.#a=!1,this.dispatchEvent(new CustomEvent("gwp:removed",{detail:{variantId:this.#i},bubbles:!0}))}catch(t){console.error("giftwithpurchase: bulk remove error",t),this.dispatchEvent(new CustomEvent("gwp:error",{detail:{action:"remove",error:t.message},bubbles:!0}))}}getState(){return{currentAmount:this.#e,threshold:this.#t,variantId:this.#i,isActive:this.#s,isAdded:this.#a,promoEnded:this.#r,remainingAmount:Math.max(0,this.#t-this.#e)}}get currentAmount(){return this.#e}get threshold(){return this.#t}get variantId(){return this.#i}get isActive(){return this.#s}get isAdded(){return this.#a}get promoEnded(){return this.#r}setCurrentAmount(t){this.#e=parseFloat(t)||0,this.#b({items:[]}),this.#p()}setThreshold(t){this.#t=parseFloat(t)||0,this.#b({items:[]}),this.#p()}setVariantId(t){this.#i=t}}customElements.get("gift-with-purchase")||customElements.define("gift-with-purchase",e),t.GiftWithPurchase=e});
//# sourceMappingURL=gift-with-purchase.min.js.map
